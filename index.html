<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>Todos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.0/redux.min.js"></script>
  <script src="https://unpkg.com/react/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone/babel.min.js"></script>
  <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
</head>
<body>

  <div id="app"></div>

  <script src="./index.js"></script>
  <script type="text/babel">
    const List = props => (
      <ul>
        {props.items.map(item =>
          <li key={item.id}>
            <span
              onClick={() => props.toggle && props.toggle(item.id)}
              style={{textDecoration: item.complete ? 'line-through' : 'none'}}
            >
              {item.name}
            </span>
            <button onClick={() => props.remove(item)}>X</button>
          </li>
        )}
      </ul>
    );

    class Todos extends React.Component {

      // Make sure a todo item gets added to the server before adding it to the local state
      addItem = async e => {
        e.preventDefault();

        try {
          const todo = await API.saveTodo(this.input.value);
          this.props.store.dispatch(addTodoAction(todo));
          this.input.value = '';
        } catch (err) {
          alert("An error occurred. Try again.");
        }
      }

      // Optimistically remove a todo item from the local state before making sure that it's removed from the server
      removeItem = async todo => {
        this.props.store.dispatch(removeTodoAction(todo.id));
        try {
          await API.deleteTodo(todo.id);
        } catch (err) {
          this.props.store.dispatch(addTodoAction(todo.id));
          alert("An error occurred. Try again.");
        }
      }

      // Optimistically toggle a todo item in the local state before making sure that it toggled on the server
      toggleItem = async id => {
        this.props.store.dispatch(toggleTodoAction(id));
        try {
          await API.saveTodoToggle(id);
        } catch (err) {
          this.props.store.dispatch(toggleTodoAction(id));
          alert("An error occurred. Try again.");
        }
      }

      render() {
        return (
          <div>
            <h1>Todo List</h1>
            <input
              type="text"
              placeholder="Add todo"
              ref={input => this.input = input}
            />
            <button onClick={this.addItem}>Add Todo</button>

            <List items={this.props.todos} toggle={this.toggleItem} remove={this.removeItem} />
          </div>
        );
      }
    }

    class Goals extends React.Component {

      // Make sure the goal is added on the server before adding it to the local state
      addItem = async e => {
        e.preventDefault();

        try {
          const goal = await API.saveGoal(this.input.value);
          this.props.store.dispatch(addGoalAction(goal));
          this.input.value = '';
        } catch (err) {
          alert("An error occurred. Try again.");
        }
      }

      // Optimistically remove a goal from the local state before making sure that it's removed from the server
      removeItem = async goal => {
        this.props.store.dispatch(removeGoalAction(goal.id));
        try {
          await API.deleteGoal(goal.id);
        } catch (err) {
          this.props.store.dispatch(addGoalAction(goal.id));
          alert("An error occurred. Try again.");
        }
      }

      render() {
        return (
          <div>
            <h1>Goals</h1>
            <input
              type="text"
              placeholder="Add goal"
              ref={input => this.input = input}
            />
            <button onClick={this.addItem}>Add Goal</button>

            <List items={this.props.goals} remove={this.removeItem} />
          </div>
        );
      }
    }

    class App extends React.Component {
      async componentDidMount() {
        const store = this.props.store;
        const [todos, goals] = await Promise.all([
          API.fetchTodos(),
          API.fetchGoals()
        ]);

        store.subscribe(() => this.forceUpdate());
        store.dispatch(receiveDataAction(todos, goals));
      }

      render() {
        const { todos, goals, loading } = this.props.store.getState();

        if (loading) {
          return <h3>Loading...</h3>;
        }

        return (
          <div>
            <Todos store={this.props.store} todos={todos} />
            <Goals store={this.props.store} goals={goals} />
          </div>
        );
      }
    }

    ReactDOM.render(<App store={store} />, document.getElementById('app'))
  </script>
</body>
</html>
